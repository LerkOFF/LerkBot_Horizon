# LERK Bot

Discord бот для интеграции с игрой Space Station 14 (SS14). Бот предоставляет команды для управления достижениями игроков, просмотра статистики, управления пользователями и взаимодействия с базой данных SS14.

## Описание

LERK Bot — это Python-приложение на базе [py-cord](https://github.com/Pycord-Development/pycord), которое интегрирует Discord-сервер с игровым сервером Space Station 14. Бот позволяет:

- Управлять достижениями игроков SS14 через Discord-команды
- Просматривать топы игроков по наигранному времени и банковскому балансу
- Управлять ckey пользователей и их настройками
- Отслеживать изменения ролей и управлять разрешениями
- Взаимодействовать с базой данных PostgreSQL SS14

## Структура проекта

```
LERK_bot/
├── main.py                    # Точка входа приложения
├── config.py                  # Конфигурация и загрузка переменных окружения
├── database.py                # Класс для работы с БД SS14 (PostgreSQL)
├── requirements.txt           # Зависимости Python
├── .env.example              # Пример файла конфигурации
├── .gitignore                # Игнорируемые файлы Git
│
├── cogs/                      # Модули команд и событий Discord
│   ├── __init__.py
│   ├── achievements.py       # Команды управления достижениями
│   ├── db_commands.py        # Команды запросов к БД (топы)
│   ├── role_events.py        # Обработчики событий ролей
│   └── user_commands.py      # Пользовательские команды
│
├── services/                  # Сервисы интеграции
│   ├── __init__.py
│   ├── achievements_catalog.py      # Каталог достижений
│   └── player_achievements_store.py # Хранилище достижений игроков
│
├── utils/                     # Утилиты
│   ├── __init__.py
│   ├── logger.py             # Настройка логирования
│   └── utils.py              # Вспомогательные функции
│
├── data/                      # Данные (файлы достижений)
│   ├── reachs.txt            # Каталог достижений
│   └── players_reachs.txt    # Достижения игроков
│
├── scripts/                   # Скрипты
│   └── lerkbot.sh            # Скрипт запуска бота
│
└── docs/                      # Документация
    ├── privacy-policy.md
    └── terms-of-service.md
```

## Требования

- Python 3.11 или выше
- PostgreSQL база данных SS14
- Discord Bot Token
- Доступ к серверу SS14 (для работы с базой данных)

## Установка

1. **Клонируйте репозиторий** (если применимо) или скачайте проект

2. **Создайте виртуальное окружение** (рекомендуется):
   ```bash
   python -m venv venv
   # Windows
   venv\Scripts\activate
   # Linux/Mac
   source venv/bin/activate
   ```

3. **Установите зависимости**:
   ```bash
   pip install -r requirements.txt
   ```

4. **Настройте переменные окружения**:
   
   Скопируйте `.env.example` в `.env` и заполните необходимые значения:
   ```bash
   cp .env.example .env
   ```
   
   Отредактируйте `.env` и укажите:
   - `DISCORD_TOKEN` — токен Discord бота
   - `GUILD_IDS` — ID Discord серверов (через запятую)
   - `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASSWORD` — параметры подключения к БД SS14
   - Другие необходимые параметры (см. раздел "Конфигурация")

## Конфигурация

Все настройки бота хранятся в файле `.env`. Обязательные переменные:

### Discord
- `DISCORD_TOKEN` — токен бота Discord
- `GUILD_IDS` — список ID серверов через запятую (например: `123456789,987654321`)

### База данных SS14
- `DB_HOST` — адрес хоста PostgreSQL
- `DB_PORT` — порт PostgreSQL
- `DB_NAME` — имя базы данных
- `DB_USER` — имя пользователя БД
- `DB_PASSWORD` — пароль БД

### Роли и каналы
- `TRACKED_ROLES` — ID отслеживаемых ролей (через запятую)
- `CKEY_CHANNEL_ID` — ID канала для ckey
- `INFO_CHANNEL_ID` — ID информационного канала
- `BOOSTY_ROLE_ID` — ID роли Boosty
- `ACHIEVEMENTS_ALLOWED_ROLE_IDS` — ID ролей с правами управления достижениями (через запятую)
- `TOP_COMMANDS_ALLOWED_CHANNELS` — ID каналов для топ-команд (через запятую)

### Файлы и пути
- `SPONSORS_FILE_PATH` — путь к файлу спонсоров
- `LOG_FILE_PATH` — путь к файлу логов
- `DISPOSABLE_FILE_PATH` — путь к файлу disposable токенов
- `ACHIEVEMENTS_CATALOG_PATH` — путь к файлу каталога достижений (по умолчанию: `data/reachs.txt`)
- `PLAYERS_ACHIEVEMENTS_PATH` — путь к файлу достижений игроков (по умолчанию: `data/players_reachs.txt`)

### Права доступа
- `CAN_GIVES_ROLES` — список ролей, которые могут выдавать роли (через запятую)

## Запуск

### Запуск через Python
```bash
python main.py
```

### Запуск через скрипт (Linux/Mac)
```bash
chmod +x scripts/lerkbot.sh
./scripts/lerkbot.sh
```

## Команды бота

### Пользовательские команды

- `/my_ckey` — указать ваш ckey в игре
- `/change_my_name_color [hex]` — изменить цвет имени на сайте (HEX-код)
- `/roll [формат]` — бросить кубики (например: `1d6+2`, `2d20`)

### Команды статистики

- `/top_play_time` — показать топ-10 игроков по наигранному времени
- `/top_balance` — показать всех игроков по балансу (пагинация по 10, кнопки Назад/Вперёд)

### Команды достижений

- `/get_reachs [имя_игрока]` — получить список достижений игрока по имени в SS14
- `/set_reach` — выдать достижение игроку через dropdown меню (требуются права)
- `/remove_reach` — удалить достижение у игрока через dropdown меню (требуются права)
- `/add_reachs` — добавить достижение в каталог через модальное окно (требуются права)
- `/edit_reachs` — редактировать достижение в каталоге (требуются права)
- `/delete_reachs` — удалить достижение из каталога через dropdown меню (требуются права)

### Административные команды

- `/add_disposable [ckey]` — добавить disposable токены пользователю по его ckey

## Архитектура

Бот построен по модульной архитектуре:

- **cogs/** — команды и обработчики событий Discord, организованные по функциональности
- **services/** — бизнес-логика и интеграции (каталог достижений, хранилище данных)
- **utils/** — вспомогательные утилиты и логирование
- **database.py** — абстракция для работы с PostgreSQL базой данных SS14

### Работа с базой данных

Бот использует `asyncpg` для асинхронной работы с PostgreSQL. Подключение к БД устанавливается при запуске бота через пул соединений.

### Система достижений

- **Каталог достижений** (`achievements_catalog.py`) — управляет списком доступных достижений
- **Хранилище достижений** (`player_achievements_store.py`) — хранит достижения игроков в файловой системе
- Все достижения сохраняются атомарно с использованием временных файлов

## Безопасность

- Все секреты хранятся в `.env` (файл не должен попадать в Git)
- Проверка прав доступа для административных команд
- Валидация и нормализация входных данных (ckey, имена игроков)
- Атомарные операции записи файлов
- Логирование действий пользователей

## Логирование

Бот использует стандартный модуль `logging` Python. Настройка логирования находится в `utils/logger.py`. Все важные действия логируются с соответствующими уровнями (INFO, WARNING, ERROR).


## Контакты

lerk@joulerk.ru
